{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "YpsY58P-RCYN"
   },
   "source": [
    "# Liliput report queries \n",
    "\n",
    "* https://docs.google.com/document/d/1HafQvQiMa2VMcMyRe08swL6Cg47HCNOjp-g-FUwslpE/edit#heading=h.asdkblljy1p\n",
    "\n",
    "* https://lilliput.dimensions.ai/discover/publication"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "## Prerequisites\n",
    "\n",
    "Connect to the DB\n",
    "\n",
    "### Connect using local credentials.."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "Collapsed": "false",
    "colab": {},
    "colab_type": "code",
    "id": "D4utwMMnRCYN",
    "outputId": "95e2fec9-7eaf-4e5f-c3e8-61a1d04aae8d"
   },
   "outputs": [],
   "source": [
    "!pip install google-cloud-bigquery -U --quiet\n",
    "from google.cloud import bigquery\n",
    "import os\n",
    "project_id = \"ds-data-solutions-gbq\"\n",
    "os.environ[\"GCLOUD_PROJECT\"] = project_id\n",
    "os.environ[\"GOOGLE_APPLICATION_CREDENTIALS\"] = \"/Users/michele.pasin/.config/gcloud/application_default_credentials.json\"\n",
    "client = bigquery.Client()\n",
    "%load_ext google.cloud.bigquery"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "DCOx1CmDRhTO"
   },
   "source": [
    "### Or connect using Colab auth.."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 34
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 19460,
     "status": "ok",
     "timestamp": 1591810013714,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "zp26ijPMRMG4",
    "outputId": "e646a561-8eba-44ab-a68f-a7068b2d0ffa"
   },
   "outputs": [],
   "source": [
    "from google.colab import auth\n",
    "auth.authenticate_user()\n",
    "print('Authenticated')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 51
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 938,
     "status": "ok",
     "timestamp": 1591810061646,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "5O1kjYkrRYGB",
    "outputId": "66818ae7-fb48-49d4-ee7d-20b01f62634c"
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The google.cloud.bigquery extension is already loaded. To reload it, use:\n",
      "  %reload_ext google.cloud.bigquery\n"
     ]
    }
   ],
   "source": [
    "project_id = \"ds-data-solutions-gbq\"\n",
    "%load_ext google.cloud.bigquery"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "### Set up params variable\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 51
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 938,
     "status": "ok",
     "timestamp": 1591810061646,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "5O1kjYkrRYGB",
    "outputId": "66818ae7-fb48-49d4-ee7d-20b01f62634c"
   },
   "outputs": [],
   "source": [
    "# eg for params\n",
    "bq_params = {}\n",
    "bq_params[\"journal_id\"] = \"jour.1115214\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "dZuULffTRCYR"
   },
   "source": [
    "## 1. basic stats"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "dZuULffTRCYR"
   },
   "source": [
    "### Publications"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 419
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 3528,
     "status": "ok",
     "timestamp": 1591811014099,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "RxXDe_5tRCYU",
    "outputId": "160e186a-ccda-47d6-e8e0-6289cbd79ce1"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "      <th>year</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>1948.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>6</td>\n",
       "      <td>1949.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>10</td>\n",
       "      <td>1950.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>11</td>\n",
       "      <td>1951.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>69</th>\n",
       "      <td>1088</td>\n",
       "      <td>2016.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>70</th>\n",
       "      <td>990</td>\n",
       "      <td>2017.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>71</th>\n",
       "      <td>982</td>\n",
       "      <td>2018.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>72</th>\n",
       "      <td>999</td>\n",
       "      <td>2019.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>73</th>\n",
       "      <td>445</td>\n",
       "      <td>2020.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>74 rows × 2 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "     tot    year\n",
       "0      1     NaN\n",
       "1      2  1948.0\n",
       "2      6  1949.0\n",
       "3     10  1950.0\n",
       "4     11  1951.0\n",
       "..   ...     ...\n",
       "69  1088  2016.0\n",
       "70   990  2017.0\n",
       "71   982  2018.0\n",
       "72   999  2019.0\n",
       "73   445  2020.0\n",
       "\n",
       "[74 rows x 2 columns]"
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "with liliput as (\n",
    "  SELECT researcher_id\n",
    "  from `ds-data-solutions-gbq.liliput01.researchers`\n",
    ")\n",
    "select count(distinct p.id) as tot, year \n",
    "  from `dimensions-ai.data_analytics.publications` p, unnest(author_researcher_ids) allres\n",
    "  join liliput on liliput.researcher_id = allres\n",
    "group by year \n",
    "order by year asc"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "I7KusEklRCYW"
   },
   "source": [
    "### Datasets "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 762
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 4129,
     "status": "ok",
     "timestamp": 1591811698260,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "-hpYm4qmVSNt",
    "outputId": "8f1b6f7b-79cf-45bd-8508-85ba135dcbec"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "      <th>year</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>4</td>\n",
       "      <td>1996</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>1998</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>28</td>\n",
       "      <td>1999</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>3</td>\n",
       "      <td>2000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>6</td>\n",
       "      <td>2002</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>6</td>\n",
       "      <td>2003</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>2</td>\n",
       "      <td>2004</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>14</td>\n",
       "      <td>2005</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>10</td>\n",
       "      <td>2006</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>21</td>\n",
       "      <td>2007</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>13</td>\n",
       "      <td>2008</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>35</td>\n",
       "      <td>2009</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>17</td>\n",
       "      <td>2010</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>32</td>\n",
       "      <td>2011</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>28</td>\n",
       "      <td>2012</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>81</td>\n",
       "      <td>2013</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>51</td>\n",
       "      <td>2014</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>81</td>\n",
       "      <td>2015</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>79</td>\n",
       "      <td>2016</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>40</td>\n",
       "      <td>2017</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>30</td>\n",
       "      <td>2018</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>63</td>\n",
       "      <td>2019</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>33</td>\n",
       "      <td>2020</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    tot  year\n",
       "0     4  1996\n",
       "1     1  1998\n",
       "2    28  1999\n",
       "3     3  2000\n",
       "4     6  2002\n",
       "5     6  2003\n",
       "6     2  2004\n",
       "7    14  2005\n",
       "8    10  2006\n",
       "9    21  2007\n",
       "10   13  2008\n",
       "11   35  2009\n",
       "12   17  2010\n",
       "13   32  2011\n",
       "14   28  2012\n",
       "15   81  2013\n",
       "16   51  2014\n",
       "17   81  2015\n",
       "18   79  2016\n",
       "19   40  2017\n",
       "20   30  2018\n",
       "21   63  2019\n",
       "22   33  2020"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "with liliput as (\n",
    "  SELECT researcher_id\n",
    "  from `ds-data-solutions-gbq.liliput01.researchers`\n",
    ")\n",
    "select count(distinct p.id) as tot, EXTRACT(YEAR FROM CAST(publication_date AS DATE)) as year  \n",
    "  from `dimensions-ai.data_analytics.data_sets` p, unnest(researcher_ids) allres\n",
    "  join liliput on liliput.researcher_id = allres\n",
    "group by year \n",
    "order by year asc"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "SXTgevbAVcFA"
   },
   "source": [
    "### Patents\n",
    "\n",
    "can't be done as we don't have researchers links"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "Collapsed": "false",
    "colab": {},
    "colab_type": "code",
    "id": "xU-zonnZVdsi"
   },
   "outputs": [],
   "source": [
    "# %%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "# with liliput as (\n",
    "#   SELECT researcher_id\n",
    "#   from `ds-data-solutions-gbq.liliput01.researchers`\n",
    "# )\n",
    "# select count(distinct p.id) as tot, year \n",
    "#   from `dimensions-ai.data_analytics.patents` p, unnest(researcher_ids) allres\n",
    "#   join liliput on liliput.researcher_id = allres\n",
    "# group by year \n",
    "# order by year asc"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "QJL3rAjBVeFo"
   },
   "source": [
    "### Grants\n",
    "\n",
    "including active and inactive infos\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 419
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 4356,
     "status": "ok",
     "timestamp": 1591813083949,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "vMGmq0mnVfjJ",
    "outputId": "0dbd935c-7bc8-4144-f2eb-db5ebc183a23"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "      <th>start_year</th>\n",
       "      <th>status</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>5</td>\n",
       "      <td>NaN</td>\n",
       "      <td>inactive</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>1968.0</td>\n",
       "      <td>inactive</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1</td>\n",
       "      <td>1969.0</td>\n",
       "      <td>inactive</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1</td>\n",
       "      <td>1970.0</td>\n",
       "      <td>inactive</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2</td>\n",
       "      <td>1971.0</td>\n",
       "      <td>inactive</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>73</th>\n",
       "      <td>7</td>\n",
       "      <td>2018.0</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>74</th>\n",
       "      <td>6</td>\n",
       "      <td>2018.0</td>\n",
       "      <td>inactive</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>75</th>\n",
       "      <td>14</td>\n",
       "      <td>2019.0</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>76</th>\n",
       "      <td>2</td>\n",
       "      <td>2019.0</td>\n",
       "      <td>inactive</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>77</th>\n",
       "      <td>3</td>\n",
       "      <td>2020.0</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>78 rows × 3 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "    tot  start_year    status\n",
       "0     5         NaN  inactive\n",
       "1     1      1968.0  inactive\n",
       "2     1      1969.0  inactive\n",
       "3     1      1970.0  inactive\n",
       "4     2      1971.0  inactive\n",
       "..  ...         ...       ...\n",
       "73    7      2018.0    active\n",
       "74    6      2018.0  inactive\n",
       "75   14      2019.0    active\n",
       "76    2      2019.0  inactive\n",
       "77    3      2020.0    active\n",
       "\n",
       "[78 rows x 3 columns]"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "with liliput as (\n",
    "  SELECT researcher_id\n",
    "  from `ds-data-solutions-gbq.liliput01.researchers`\n",
    ")\n",
    "select count(distinct p.id) as tot, start_year, \n",
    "  CASE\n",
    "    WHEN PARSE_DATE('%Y-%m-%d', end_date) >= CURRENT_DATE() THEN \"active\"\n",
    "    ELSE \"inactive\"\n",
    "  END AS status\n",
    "  from `dimensions-ai.data_analytics.grants` p, unnest(researchers) allres\n",
    "  join liliput on liliput.researcher_id = allres.id\n",
    "group by start_year, status \n",
    "order by start_year asc"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "ruANNefqVf3E"
   },
   "source": [
    "### Cl Trials"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 204
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 3818,
     "status": "ok",
     "timestamp": 1591813173445,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "ChvMJXHyVh6W",
    "outputId": "172c2f57-96d8-41bc-e260-0d19404fc56b"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "      <th>start_year</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>2005</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>2009</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1</td>\n",
       "      <td>2012</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2</td>\n",
       "      <td>2013</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1</td>\n",
       "      <td>2014</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   tot  start_year\n",
       "0    1        2005\n",
       "1    1        2009\n",
       "2    1        2012\n",
       "3    2        2013\n",
       "4    1        2014"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "with liliput as (\n",
    "  SELECT researcher_id\n",
    "  from `ds-data-solutions-gbq.liliput01.researchers`\n",
    ")\n",
    "select count(distinct p.id) as tot, start_year\n",
    "  from `dimensions-ai.data_analytics.clinical_trials` p, unnest(investigators) allres\n",
    "  join liliput on liliput.researcher_id = allres.id\n",
    "group by start_year \n",
    "order by start_year asc"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "Collapsed": "false",
    "colab": {},
    "colab_type": "code",
    "id": "YvbxJm0UdTiK"
   },
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "8cYEqJkJdhkO"
   },
   "source": [
    "## 2. researchers \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 80
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 3710,
     "status": "ok",
     "timestamp": 1591813276531,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "T8dVbdVzdlpg",
    "outputId": "dcadcddd-070b-4da4-ee21-e9480a7eab66"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>tot</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>138</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   tot\n",
       "0  138"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "with liliput as (\n",
    "  SELECT researcher_id\n",
    "  from `ds-data-solutions-gbq.liliput01.researchers`\n",
    ")\n",
    "select count(distinct researcher_id) as tot\n",
    "  from liliput"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "oqingSKldvSd"
   },
   "source": [
    "### Demographics"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 514
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 2616,
     "status": "ok",
     "timestamp": 1591817657054,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "PDpG7wqFse4Z",
    "outputId": "e16e118b-4091-4666-c099-eb8dc8397896"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>researchers</th>\n",
       "      <th>Gender</th>\n",
       "      <th>age</th>\n",
       "      <th>age_group</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>83.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>Female</td>\n",
       "      <td>73.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>73.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2</td>\n",
       "      <td>Male</td>\n",
       "      <td>80.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>84.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>76.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>67.0</td>\n",
       "      <td>60+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>88.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>99.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>92.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>68.0</td>\n",
       "      <td>60+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>1</td>\n",
       "      <td>Female</td>\n",
       "      <td>72.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>1</td>\n",
       "      <td>Male</td>\n",
       "      <td>96.0</td>\n",
       "      <td>70+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>1</td>\n",
       "      <td>Female</td>\n",
       "      <td>59.0</td>\n",
       "      <td>50+</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>123</td>\n",
       "      <td>None</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0-30</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    researchers  Gender   age age_group\n",
       "0             1    Male  83.0       70+\n",
       "1             1  Female  73.0       70+\n",
       "2             1    Male  73.0       70+\n",
       "3             2    Male  80.0       70+\n",
       "4             1    Male  84.0       70+\n",
       "5             1    Male  76.0       70+\n",
       "6             1    Male  67.0       60+\n",
       "7             1    Male  88.0       70+\n",
       "8             1    Male  99.0       70+\n",
       "9             1    Male  92.0       70+\n",
       "10            1    Male  68.0       60+\n",
       "11            1  Female  72.0       70+\n",
       "12            1    Male  96.0       70+\n",
       "13            1  Female  59.0       50+\n",
       "14          123    None   NaN      0-30"
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "SELECT count(distinct researcher_id) as researchers, Gender, DATE_DIFF(CURRENT_DATE(), Date_of_Birth, YEAR) as age,\n",
    "  CASE\n",
    "    WHEN DATE_DIFF(CURRENT_DATE(), Date_of_Birth, YEAR) > 70 THEN \"70+\"\n",
    "    WHEN DATE_DIFF(CURRENT_DATE(), Date_of_Birth, YEAR) > 60 THEN \"60+\"\n",
    "    WHEN DATE_DIFF(CURRENT_DATE(), Date_of_Birth, YEAR) > 50 THEN \"50+\"\n",
    "    WHEN DATE_DIFF(CURRENT_DATE(), Date_of_Birth, YEAR) > 40 THEN \"40+\"\n",
    "    WHEN DATE_DIFF(CURRENT_DATE(), Date_of_Birth, YEAR) > 30 THEN \"30+\"\n",
    "    ELSE \"0-30\"\n",
    "  END AS age_group\n",
    "  from `ds-data-solutions-gbq.liliput01.researchers`\n",
    "  group by Gender, age, age_group"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "4ocFg3ZbeHf0"
   },
   "source": [
    "### Collaborations including geo information"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "Collapsed": "false",
    "colab": {
     "base_uri": "https://localhost:8080/",
     "height": 419
    },
    "colab_type": "code",
    "executionInfo": {
     "elapsed": 6653,
     "status": "ok",
     "timestamp": 1591818680994,
     "user": {
      "displayName": "Michele Pasin",
      "photoUrl": "https://lh3.googleusercontent.com/a-/AOh14GjipTjNOii6dOauGPuXYYkJI5yDxiFjhaKyo9n3dQ=s64",
      "userId": "16817767946054086877"
     },
     "user_tz": -60
    },
    "id": "feyaBjNKvF_a",
    "outputId": "441738ec-9b9d-46c8-d56d-9e098c11f084"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>pubs</th>\n",
       "      <th>grid_id</th>\n",
       "      <th>name</th>\n",
       "      <th>country</th>\n",
       "      <th>city</th>\n",
       "      <th>latlong</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1381</td>\n",
       "      <td>grid.168010.e</td>\n",
       "      <td>Stanford University</td>\n",
       "      <td>United States</td>\n",
       "      <td>Stanford</td>\n",
       "      <td>37.430000305175781, -122.16999816894531</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1153</td>\n",
       "      <td>grid.410786.c</td>\n",
       "      <td>Kitasato University</td>\n",
       "      <td>Japan</td>\n",
       "      <td>Tokyo</td>\n",
       "      <td>35.642559051513672, 139.72563171386719</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1119</td>\n",
       "      <td>grid.4830.f</td>\n",
       "      <td>University of Groningen</td>\n",
       "      <td>Netherlands</td>\n",
       "      <td>Groningen</td>\n",
       "      <td>53.219444274902344, 6.5629658699035645</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1076</td>\n",
       "      <td>grid.38142.3c</td>\n",
       "      <td>Harvard University</td>\n",
       "      <td>United States</td>\n",
       "      <td>Cambridge</td>\n",
       "      <td>42.377052307128906, -71.116653442382812</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1061</td>\n",
       "      <td>grid.258799.8</td>\n",
       "      <td>Kyoto University</td>\n",
       "      <td>Japan</td>\n",
       "      <td>Kyoto</td>\n",
       "      <td>35.026157379150391, 135.77978515625</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3790</th>\n",
       "      <td>1</td>\n",
       "      <td>grid.266518.e</td>\n",
       "      <td>University of Karachi</td>\n",
       "      <td>Pakistan</td>\n",
       "      <td>Karachi</td>\n",
       "      <td>24.9408016204834, 67.1202392578125</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3791</th>\n",
       "      <td>1</td>\n",
       "      <td>grid.418953.2</td>\n",
       "      <td>Institute of Cytology and Genetics</td>\n",
       "      <td>Russia</td>\n",
       "      <td>Novosibirsk</td>\n",
       "      <td>54.847682952880859, 83.107002258300781</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3792</th>\n",
       "      <td>1</td>\n",
       "      <td>grid.6083.d</td>\n",
       "      <td>National Centre of Scientific Research Demokritos</td>\n",
       "      <td>Greece</td>\n",
       "      <td>Athens</td>\n",
       "      <td>37.9991455078125, 23.818248748779297</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3793</th>\n",
       "      <td>1</td>\n",
       "      <td>grid.22459.38</td>\n",
       "      <td>National Hellenic Research Foundation</td>\n",
       "      <td>Greece</td>\n",
       "      <td>Athens</td>\n",
       "      <td>37.974067687988281, 23.745809555053711</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3794</th>\n",
       "      <td>1</td>\n",
       "      <td>grid.414818.0</td>\n",
       "      <td>Fondazione IRCCS Ca' Granda Ospedale Maggiore ...</td>\n",
       "      <td>Italy</td>\n",
       "      <td>Milan</td>\n",
       "      <td>45.45867919921875, 9.197662353515625</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>3795 rows × 6 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "      pubs        grid_id                                               name  \\\n",
       "0     1381  grid.168010.e                                Stanford University   \n",
       "1     1153  grid.410786.c                                Kitasato University   \n",
       "2     1119    grid.4830.f                            University of Groningen   \n",
       "3     1076  grid.38142.3c                                 Harvard University   \n",
       "4     1061  grid.258799.8                                   Kyoto University   \n",
       "...    ...            ...                                                ...   \n",
       "3790     1  grid.266518.e                              University of Karachi   \n",
       "3791     1  grid.418953.2                 Institute of Cytology and Genetics   \n",
       "3792     1    grid.6083.d  National Centre of Scientific Research Demokritos   \n",
       "3793     1  grid.22459.38              National Hellenic Research Foundation   \n",
       "3794     1  grid.414818.0  Fondazione IRCCS Ca' Granda Ospedale Maggiore ...   \n",
       "\n",
       "            country         city                                  latlong  \n",
       "0     United States     Stanford  37.430000305175781, -122.16999816894531  \n",
       "1             Japan        Tokyo   35.642559051513672, 139.72563171386719  \n",
       "2       Netherlands    Groningen   53.219444274902344, 6.5629658699035645  \n",
       "3     United States    Cambridge  42.377052307128906, -71.116653442382812  \n",
       "4             Japan        Kyoto      35.026157379150391, 135.77978515625  \n",
       "...             ...          ...                                      ...  \n",
       "3790       Pakistan      Karachi       24.9408016204834, 67.1202392578125  \n",
       "3791         Russia  Novosibirsk   54.847682952880859, 83.107002258300781  \n",
       "3792         Greece       Athens     37.9991455078125, 23.818248748779297  \n",
       "3793         Greece       Athens   37.974067687988281, 23.745809555053711  \n",
       "3794          Italy        Milan     45.45867919921875, 9.197662353515625  \n",
       "\n",
       "[3795 rows x 6 columns]"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "with liliput as (\n",
    "  SELECT researcher_id\n",
    "  from `ds-data-solutions-gbq.liliput01.researchers`\n",
    "),\n",
    "grids_list as (\n",
    "  select count(distinct p.id) as pubs, grid_id\n",
    "    from `dimensions-ai.data_analytics.publications` p, unnest(author_researcher_ids) allres, unnest(author_grid_ids) grid_id\n",
    "    join liliput on liliput.researcher_id = allres\n",
    "    group by grid_id\n",
    ") \n",
    "select pubs, grid_id, grid.name, geo.country, geo.city, CONCAT(geo.lat, ', ', geo.lng) AS latlong\n",
    "from grids_list\n",
    "join `dimensions-ai.data_analytics.grid` grid on grid.id = grids_list.grid_id, UNNEST(addresses) as geo\n",
    "order by pubs desc\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "4ocFg3ZbeHf0"
   },
   "source": [
    "## 3. Publishing Behaviour"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false",
    "colab_type": "text",
    "id": "4ocFg3ZbeHf0"
   },
   "source": [
    "### Fields of Research\n",
    "\n",
    "NOTE comparisons are made across publications that HAVE at least one FOR code"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>name</th>\n",
       "      <th>pubs_global</th>\n",
       "      <th>pubs_global_pc</th>\n",
       "      <th>pubs_local</th>\n",
       "      <th>pubs_local_pc</th>\n",
       "      <th>delta</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Agricultural and Veterinary Sciences</td>\n",
       "      <td>2017344</td>\n",
       "      <td>2.48</td>\n",
       "      <td>166</td>\n",
       "      <td>0.49</td>\n",
       "      <td>1.99</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Biological Sciences</td>\n",
       "      <td>8633215</td>\n",
       "      <td>10.60</td>\n",
       "      <td>9041</td>\n",
       "      <td>26.71</td>\n",
       "      <td>-16.11</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Built Environment and Design</td>\n",
       "      <td>455577</td>\n",
       "      <td>0.56</td>\n",
       "      <td>7</td>\n",
       "      <td>0.02</td>\n",
       "      <td>0.54</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Chemical Sciences</td>\n",
       "      <td>7572654</td>\n",
       "      <td>9.30</td>\n",
       "      <td>7732</td>\n",
       "      <td>22.84</td>\n",
       "      <td>-13.54</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Commerce, Management, Tourism and Services</td>\n",
       "      <td>1699985</td>\n",
       "      <td>2.09</td>\n",
       "      <td>613</td>\n",
       "      <td>1.81</td>\n",
       "      <td>0.28</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>Earth Sciences</td>\n",
       "      <td>1966038</td>\n",
       "      <td>2.42</td>\n",
       "      <td>71</td>\n",
       "      <td>0.21</td>\n",
       "      <td>2.21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>Economics</td>\n",
       "      <td>1638927</td>\n",
       "      <td>2.01</td>\n",
       "      <td>2241</td>\n",
       "      <td>6.62</td>\n",
       "      <td>-4.61</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>Education</td>\n",
       "      <td>1689933</td>\n",
       "      <td>2.08</td>\n",
       "      <td>36</td>\n",
       "      <td>0.11</td>\n",
       "      <td>1.97</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>Engineering</td>\n",
       "      <td>11663754</td>\n",
       "      <td>14.33</td>\n",
       "      <td>3637</td>\n",
       "      <td>10.75</td>\n",
       "      <td>3.58</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>Environmental Sciences</td>\n",
       "      <td>1293430</td>\n",
       "      <td>1.59</td>\n",
       "      <td>94</td>\n",
       "      <td>0.28</td>\n",
       "      <td>1.31</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>History and Archaeology</td>\n",
       "      <td>2227799</td>\n",
       "      <td>2.74</td>\n",
       "      <td>42</td>\n",
       "      <td>0.12</td>\n",
       "      <td>2.62</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>Information and Computing Sciences</td>\n",
       "      <td>4793802</td>\n",
       "      <td>5.89</td>\n",
       "      <td>381</td>\n",
       "      <td>1.13</td>\n",
       "      <td>4.76</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>Language, Communication and Culture</td>\n",
       "      <td>2365009</td>\n",
       "      <td>2.91</td>\n",
       "      <td>193</td>\n",
       "      <td>0.57</td>\n",
       "      <td>2.34</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>Law and Legal Studies</td>\n",
       "      <td>826205</td>\n",
       "      <td>1.01</td>\n",
       "      <td>76</td>\n",
       "      <td>0.22</td>\n",
       "      <td>0.79</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>Mathematical Sciences</td>\n",
       "      <td>4805236</td>\n",
       "      <td>5.90</td>\n",
       "      <td>1535</td>\n",
       "      <td>4.54</td>\n",
       "      <td>1.36</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>Medical and Health Sciences</td>\n",
       "      <td>28785963</td>\n",
       "      <td>35.36</td>\n",
       "      <td>6664</td>\n",
       "      <td>19.69</td>\n",
       "      <td>15.67</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>Philosophy and Religious Studies</td>\n",
       "      <td>1591230</td>\n",
       "      <td>1.95</td>\n",
       "      <td>45</td>\n",
       "      <td>0.13</td>\n",
       "      <td>1.82</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>Physical Sciences</td>\n",
       "      <td>5932268</td>\n",
       "      <td>7.29</td>\n",
       "      <td>8815</td>\n",
       "      <td>26.04</td>\n",
       "      <td>-18.75</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>Psychology and Cognitive Sciences</td>\n",
       "      <td>3650890</td>\n",
       "      <td>4.48</td>\n",
       "      <td>430</td>\n",
       "      <td>1.27</td>\n",
       "      <td>3.21</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>Studies in Creative Arts and Writing</td>\n",
       "      <td>615514</td>\n",
       "      <td>0.76</td>\n",
       "      <td>127</td>\n",
       "      <td>0.38</td>\n",
       "      <td>0.38</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>Studies in Human Society</td>\n",
       "      <td>3184273</td>\n",
       "      <td>3.91</td>\n",
       "      <td>316</td>\n",
       "      <td>0.93</td>\n",
       "      <td>2.98</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>Technology</td>\n",
       "      <td>1863756</td>\n",
       "      <td>2.29</td>\n",
       "      <td>795</td>\n",
       "      <td>2.35</td>\n",
       "      <td>-0.06</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                                          name  pubs_global  pubs_global_pc  \\\n",
       "0         Agricultural and Veterinary Sciences      2017344            2.48   \n",
       "1                          Biological Sciences      8633215           10.60   \n",
       "2                 Built Environment and Design       455577            0.56   \n",
       "3                            Chemical Sciences      7572654            9.30   \n",
       "4   Commerce, Management, Tourism and Services      1699985            2.09   \n",
       "5                               Earth Sciences      1966038            2.42   \n",
       "6                                    Economics      1638927            2.01   \n",
       "7                                    Education      1689933            2.08   \n",
       "8                                  Engineering     11663754           14.33   \n",
       "9                       Environmental Sciences      1293430            1.59   \n",
       "10                     History and Archaeology      2227799            2.74   \n",
       "11          Information and Computing Sciences      4793802            5.89   \n",
       "12         Language, Communication and Culture      2365009            2.91   \n",
       "13                       Law and Legal Studies       826205            1.01   \n",
       "14                       Mathematical Sciences      4805236            5.90   \n",
       "15                 Medical and Health Sciences     28785963           35.36   \n",
       "16            Philosophy and Religious Studies      1591230            1.95   \n",
       "17                           Physical Sciences      5932268            7.29   \n",
       "18           Psychology and Cognitive Sciences      3650890            4.48   \n",
       "19        Studies in Creative Arts and Writing       615514            0.76   \n",
       "20                    Studies in Human Society      3184273            3.91   \n",
       "21                                  Technology      1863756            2.29   \n",
       "\n",
       "    pubs_local  pubs_local_pc  delta  \n",
       "0          166           0.49   1.99  \n",
       "1         9041          26.71 -16.11  \n",
       "2            7           0.02   0.54  \n",
       "3         7732          22.84 -13.54  \n",
       "4          613           1.81   0.28  \n",
       "5           71           0.21   2.21  \n",
       "6         2241           6.62  -4.61  \n",
       "7           36           0.11   1.97  \n",
       "8         3637          10.75   3.58  \n",
       "9           94           0.28   1.31  \n",
       "10          42           0.12   2.62  \n",
       "11         381           1.13   4.76  \n",
       "12         193           0.57   2.34  \n",
       "13          76           0.22   0.79  \n",
       "14        1535           4.54   1.36  \n",
       "15        6664          19.69  15.67  \n",
       "16          45           0.13   1.82  \n",
       "17        8815          26.04 -18.75  \n",
       "18         430           1.27   3.21  \n",
       "19         127           0.38   0.38  \n",
       "20         316           0.93   2.98  \n",
       "21         795           2.35  -0.06  "
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "-- only pubs with an FOR\n",
    "WITH liliput_pubs AS \n",
    "(\n",
    "  SELECT *\n",
    "  FROM `dimensions-ai.data_analytics.publications` p, UNNEST(author_researcher_ids) allres\n",
    "  JOIN `ds-data-solutions-gbq.liliput01.researchers` r ON r.researcher_id = allres\n",
    "  WHERE ARRAY_LENGTH(category_for) > 0    \n",
    "), \n",
    "stats_global AS \n",
    "(\n",
    "    \n",
    "    SELECT cat.first_level.name, COUNT(distinct p.id) AS pubs_global, \n",
    "        ROUND (\n",
    "            (COUNT(distinct p.id) * 100 /  -- calc percentage to total pubs - global\n",
    "                    (\n",
    "                    SELECT COUNT(distinct id) \n",
    "                    FROM `dimensions-ai.data_analytics.publications` \n",
    "                    WHERE ARRAY_LENGTH(category_for) > 0\n",
    "                    )\n",
    "                ), \n",
    "            2 )  AS pubs_global_pc \n",
    "    FROM `dimensions-ai.data_analytics.publications` p, unnest(category_for) cat\n",
    "    GROUP BY cat.first_level.name\n",
    "\n",
    "),\n",
    "\n",
    "stats_local AS \n",
    "(\n",
    "    SELECT cat.first_level.name, COUNT(distinct id) AS pubs_local, \n",
    "    ROUND (\n",
    "            (COUNT(distinct id) * 100 /   -- calc percentage to total pubs for liliput\n",
    "                ( \n",
    "                    SELECT COUNT(distinct id) \n",
    "                    FROM liliput_pubs\n",
    "                )\n",
    "            ), \n",
    "        2 )  AS pubs_local_pc \n",
    "    FROM liliput_pubs, UNNEST(category_for) cat\n",
    "    GROUP BY cat.first_level.name\n",
    ")\n",
    "SELECT stats_local.name, pubs_global, pubs_global_pc, pubs_local, pubs_local_pc, (pubs_global_pc - pubs_local_pc) AS delta\n",
    "FROM stats_global JOIN stats_local ON stats_global.name = stats_local.name\n",
    "ORDER BY stats_local.name\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "#### Tip: calc percentage of total"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {
    "Collapsed": "false",
    "colab": {},
    "colab_type": "code",
    "id": "bIE3PUXHyWAl"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>pubs_global</th>\n",
       "      <th>name</th>\n",
       "      <th>pubs_global_pc</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1290505</td>\n",
       "      <td>Environmental Sciences</td>\n",
       "      <td>1.17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>454265</td>\n",
       "      <td>Built Environment and Design</td>\n",
       "      <td>0.41</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>7562108</td>\n",
       "      <td>Chemical Sciences</td>\n",
       "      <td>6.85</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>11636113</td>\n",
       "      <td>Engineering</td>\n",
       "      <td>10.54</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>3178085</td>\n",
       "      <td>Studies in Human Society</td>\n",
       "      <td>2.88</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>1696374</td>\n",
       "      <td>Commerce, Management, Tourism and Services</td>\n",
       "      <td>1.54</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>5915637</td>\n",
       "      <td>Physical Sciences</td>\n",
       "      <td>5.36</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>823865</td>\n",
       "      <td>Law and Legal Studies</td>\n",
       "      <td>0.75</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>614805</td>\n",
       "      <td>Studies in Creative Arts and Writing</td>\n",
       "      <td>0.56</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>2362047</td>\n",
       "      <td>Language, Communication and Culture</td>\n",
       "      <td>2.14</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>4798149</td>\n",
       "      <td>Mathematical Sciences</td>\n",
       "      <td>4.35</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>1963135</td>\n",
       "      <td>Earth Sciences</td>\n",
       "      <td>1.78</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>4781866</td>\n",
       "      <td>Information and Computing Sciences</td>\n",
       "      <td>4.33</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>2224861</td>\n",
       "      <td>History and Archaeology</td>\n",
       "      <td>2.02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>2014688</td>\n",
       "      <td>Agricultural and Veterinary Sciences</td>\n",
       "      <td>1.83</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>1860405</td>\n",
       "      <td>Technology</td>\n",
       "      <td>1.69</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>8614115</td>\n",
       "      <td>Biological Sciences</td>\n",
       "      <td>7.81</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>3644099</td>\n",
       "      <td>Psychology and Cognitive Sciences</td>\n",
       "      <td>3.30</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>1634620</td>\n",
       "      <td>Economics</td>\n",
       "      <td>1.48</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>28739353</td>\n",
       "      <td>Medical and Health Sciences</td>\n",
       "      <td>26.04</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>1685678</td>\n",
       "      <td>Education</td>\n",
       "      <td>1.53</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>1589440</td>\n",
       "      <td>Philosophy and Religious Studies</td>\n",
       "      <td>1.44</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    pubs_global                                        name  pubs_global_pc\n",
       "0       1290505                      Environmental Sciences            1.17\n",
       "1        454265                Built Environment and Design            0.41\n",
       "2       7562108                           Chemical Sciences            6.85\n",
       "3      11636113                                 Engineering           10.54\n",
       "4       3178085                    Studies in Human Society            2.88\n",
       "5       1696374  Commerce, Management, Tourism and Services            1.54\n",
       "6       5915637                           Physical Sciences            5.36\n",
       "7        823865                       Law and Legal Studies            0.75\n",
       "8        614805        Studies in Creative Arts and Writing            0.56\n",
       "9       2362047         Language, Communication and Culture            2.14\n",
       "10      4798149                       Mathematical Sciences            4.35\n",
       "11      1963135                              Earth Sciences            1.78\n",
       "12      4781866          Information and Computing Sciences            4.33\n",
       "13      2224861                     History and Archaeology            2.02\n",
       "14      2014688        Agricultural and Veterinary Sciences            1.83\n",
       "15      1860405                                  Technology            1.69\n",
       "16      8614115                         Biological Sciences            7.81\n",
       "17      3644099           Psychology and Cognitive Sciences            3.30\n",
       "18      1634620                                   Economics            1.48\n",
       "19     28739353                 Medical and Health Sciences           26.04\n",
       "20      1685678                                   Education            1.53\n",
       "21      1589440            Philosophy and Religious Studies            1.44"
      ]
     },
     "execution_count": 19,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "select cat.first_level.name, count(distinct p.id) as pubs_global, \n",
    "    ROUND ((count(distinct p.id) * 100 /(SELECT count(*) FROM `dimensions-ai.data_analytics.publications`)), 2 )  as pubs_global_pc \n",
    "from `dimensions-ai.data_analytics.publications` p, unnest(category_for) cat\n",
    "group by cat.first_level.name\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "Collapsed": "false"
   },
   "source": [
    "### Funding Sources\n",
    "\n",
    "Links to grants are determined via the 'grants assignees' relationship (not the publications links). "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>name</th>\n",
       "      <th>funder</th>\n",
       "      <th>tot</th>\n",
       "      <th>tot_active</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Japan Society for the Promotion of Science</td>\n",
       "      <td>grid.54432.34</td>\n",
       "      <td>304</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Directorate for Mathematical &amp; Physical Sciences</td>\n",
       "      <td>grid.457875.c</td>\n",
       "      <td>143</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>National Institute of General Medical Sciences</td>\n",
       "      <td>grid.280785.0</td>\n",
       "      <td>92</td>\n",
       "      <td>13</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Directorate for Biological Sciences</td>\n",
       "      <td>grid.457768.f</td>\n",
       "      <td>56</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>Wellcome Trust</td>\n",
       "      <td>grid.52788.30</td>\n",
       "      <td>52</td>\n",
       "      <td>10</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>National Cancer Institute</td>\n",
       "      <td>grid.48336.3a</td>\n",
       "      <td>47</td>\n",
       "      <td>13</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>National Institute of Allergy and Infectious D...</td>\n",
       "      <td>grid.419681.3</td>\n",
       "      <td>31</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>Deutsche Forschungsgemeinschaft</td>\n",
       "      <td>grid.424150.6</td>\n",
       "      <td>30</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>Directorate for Engineering</td>\n",
       "      <td>grid.457810.f</td>\n",
       "      <td>24</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>The Research Council of Norway</td>\n",
       "      <td>grid.13985.36</td>\n",
       "      <td>22</td>\n",
       "      <td>6</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>European Research Council</td>\n",
       "      <td>grid.452896.4</td>\n",
       "      <td>18</td>\n",
       "      <td>7</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>National Institute of Neurological Disorders a...</td>\n",
       "      <td>grid.416870.c</td>\n",
       "      <td>17</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>National Heart Lung and Blood Institute</td>\n",
       "      <td>grid.279885.9</td>\n",
       "      <td>17</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>National Institute on Aging</td>\n",
       "      <td>grid.419475.a</td>\n",
       "      <td>16</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>National Institute of Mental Health</td>\n",
       "      <td>grid.416868.5</td>\n",
       "      <td>15</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>Medical Research Council</td>\n",
       "      <td>grid.14105.31</td>\n",
       "      <td>15</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>Engineering and Physical Sciences Research Cou...</td>\n",
       "      <td>grid.421091.f</td>\n",
       "      <td>12</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>Canadian Institutes of Health Research</td>\n",
       "      <td>grid.248883.d</td>\n",
       "      <td>11</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>National Institute of Diabetes and Digestive a...</td>\n",
       "      <td>grid.419635.c</td>\n",
       "      <td>8</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>Cancer Research UK</td>\n",
       "      <td>grid.11485.39</td>\n",
       "      <td>7</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>Directorate for Computer &amp; Information Science...</td>\n",
       "      <td>grid.457785.c</td>\n",
       "      <td>7</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>21</th>\n",
       "      <td>Office of Basic Energy Sciences</td>\n",
       "      <td>grid.452988.a</td>\n",
       "      <td>6</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>22</th>\n",
       "      <td>Directorate for Education &amp; Human Resources</td>\n",
       "      <td>grid.457799.1</td>\n",
       "      <td>5</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>23</th>\n",
       "      <td>National Institute of Environmental Health Sci...</td>\n",
       "      <td>grid.280664.e</td>\n",
       "      <td>4</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>24</th>\n",
       "      <td>American Association For Cancer Research</td>\n",
       "      <td>grid.280840.6</td>\n",
       "      <td>3</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25</th>\n",
       "      <td>National Institute on Drug Abuse</td>\n",
       "      <td>grid.420090.f</td>\n",
       "      <td>3</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>26</th>\n",
       "      <td>National Health and Medical Research Council</td>\n",
       "      <td>grid.431143.0</td>\n",
       "      <td>2</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>27</th>\n",
       "      <td>Swedish Heart-Lung Foundation</td>\n",
       "      <td>grid.453055.2</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                                                 name         funder  tot  \\\n",
       "0          Japan Society for the Promotion of Science  grid.54432.34  304   \n",
       "1    Directorate for Mathematical & Physical Sciences  grid.457875.c  143   \n",
       "2      National Institute of General Medical Sciences  grid.280785.0   92   \n",
       "3                 Directorate for Biological Sciences  grid.457768.f   56   \n",
       "4                                      Wellcome Trust  grid.52788.30   52   \n",
       "5                           National Cancer Institute  grid.48336.3a   47   \n",
       "6   National Institute of Allergy and Infectious D...  grid.419681.3   31   \n",
       "7                     Deutsche Forschungsgemeinschaft  grid.424150.6   30   \n",
       "8                         Directorate for Engineering  grid.457810.f   24   \n",
       "9                      The Research Council of Norway  grid.13985.36   22   \n",
       "10                          European Research Council  grid.452896.4   18   \n",
       "11  National Institute of Neurological Disorders a...  grid.416870.c   17   \n",
       "12            National Heart Lung and Blood Institute  grid.279885.9   17   \n",
       "13                        National Institute on Aging  grid.419475.a   16   \n",
       "14                National Institute of Mental Health  grid.416868.5   15   \n",
       "15                           Medical Research Council  grid.14105.31   15   \n",
       "16  Engineering and Physical Sciences Research Cou...  grid.421091.f   12   \n",
       "17             Canadian Institutes of Health Research  grid.248883.d   11   \n",
       "18  National Institute of Diabetes and Digestive a...  grid.419635.c    8   \n",
       "19                                 Cancer Research UK  grid.11485.39    7   \n",
       "20  Directorate for Computer & Information Science...  grid.457785.c    7   \n",
       "21                    Office of Basic Energy Sciences  grid.452988.a    6   \n",
       "22        Directorate for Education & Human Resources  grid.457799.1    5   \n",
       "23  National Institute of Environmental Health Sci...  grid.280664.e    4   \n",
       "24           American Association For Cancer Research  grid.280840.6    3   \n",
       "25                   National Institute on Drug Abuse  grid.420090.f    3   \n",
       "26       National Health and Medical Research Council  grid.431143.0    2   \n",
       "27                      Swedish Heart-Lung Foundation  grid.453055.2    1   \n",
       "\n",
       "    tot_active  \n",
       "0            4  \n",
       "1            1  \n",
       "2           13  \n",
       "3            2  \n",
       "4           10  \n",
       "5           13  \n",
       "6            2  \n",
       "7            1  \n",
       "8            1  \n",
       "9            6  \n",
       "10           7  \n",
       "11           4  \n",
       "12           2  \n",
       "13           5  \n",
       "14           2  \n",
       "15           1  \n",
       "16           4  \n",
       "17           1  \n",
       "18           1  \n",
       "19           1  \n",
       "20           1  \n",
       "21           3  \n",
       "22           1  \n",
       "23           2  \n",
       "24           2  \n",
       "25           2  \n",
       "26           1  \n",
       "27           1  "
      ]
     },
     "execution_count": 29,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%bigquery --params $bq_params --project $project_id \n",
    "\n",
    "WITH liliput AS (\n",
    "  SELECT researcher_id\n",
    "  FROM `ds-data-solutions-gbq.liliput01.researchers`\n",
    "),\n",
    "funders_all AS\n",
    "(\n",
    "SELECT grid.name, funder, count(distinct g.id) AS tot,\n",
    "  FROM `dimensions-ai.data_analytics.grants` g, unnest(researchers) allres\n",
    "  JOIN liliput on liliput.researcher_id = allres.id\n",
    "  JOIN `dimensions-ai.data_analytics.grid` grid ON grid.id = funder\n",
    "GROUP BY funder, grid.name \n",
    "), \n",
    "funders_active AS\n",
    "(\n",
    " SELECT funder, count(distinct g.id) AS tot_active,\n",
    "  FROM `dimensions-ai.data_analytics.grants` g, unnest(researchers) allres\n",
    "  JOIN liliput on liliput.researcher_id = allres.id\n",
    "  JOIN `dimensions-ai.data_analytics.grid` grid ON grid.id = funder\n",
    "  WHERE PARSE_DATE('%Y-%m-%d', end_date) >= CURRENT_DATE()\n",
    "GROUP BY funder    \n",
    ")\n",
    "select funders_all.* , funders_active.tot_active \n",
    "from funders_all \n",
    "join funders_active on funders_all.funder = funders_active.funder\n",
    "ORDER BY tot desc"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "Collapsed": "false"
   },
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "colab": {
   "collapsed_sections": [],
   "name": "2020-06-Liliput-Report.ipynb",
   "provenance": []
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
